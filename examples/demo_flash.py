#!/usr/bin/env python3
"""
RemoteFlasherå®Œæ•´åŠŸèƒ½æ¼”ç¤º
æ¼”ç¤ºGPIOæ§åˆ¶çš„çƒ§å½•æµç¨‹ï¼šçƒ§å½•å‰å¤ä½ -> çƒ§å½• -> çƒ§å½•åé‡å¯
"""

import time
import sys
import os
from pathlib import Path

# æ·»åŠ srcç›®å½•åˆ°Pythonè·¯å¾„
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))

from remote_flasher import RemoteFlasherClient, AVRFlasher

def create_demo_hex():
    """åˆ›å»ºæ¼”ç¤ºç”¨çš„hexæ–‡ä»¶"""
    hex_content = """:100000000C9434000C943E000C943E000C943E0082
:100010000C943E000C943E000C943E000C943E0068
:100020000C943E000C943E000C943E000C943E0058
:100030000C943E000C943E000C943E000C943E0048
:100040000C943E000C943E000C943E000C943E0038
:100050000C943E000C943E000C943E000C943E0028
:100060000C943E000C943E000C943E000C943E0018
:100070000C943E000C943E000C943E000C943E0008
:100080000C943E000C943E000C943E000C943E00F8
:100090000C943E000C943E000C943E000C943E00E8
:1000A0000C943E000C943E000C943E000C943E00D8
:1000B0000C943E000C943E000C943E000C943E00C8
:1000C0000C943E000C943E000C943E000C943E00B8
:1000D0000C943E000C943E000C943E000C943E00A8
:1000E0000C943E000C943E000C943E000C943E0098
:1000F0000C943E000C943E000C943E000C943E0088
:10010000000000000000000000000000000000007F
:10011000000000000000000000000000000000006F
:10012000000000000000000000000000000000005F
:10013000000000000000000000000000000000004F
:10014000000000000000000000000000000000003F
:10015000000000000000000000000000000000002F
:10016000000000000000000000000000000000001F
:10017000000000000000000000000000000000000F
:1001800000000000000000000000000000000000FF
:1001900000000000000000000000000000000000EF
:1001A00000000000000000000000000000000000DF
:1001B00000000000000000000000000000000000CF
:1001C00000000000000000000000000000000000BF
:1001D00000000000000000000000000000000000AF
:1001E000000000000000000000000000000000009F
:1001F000000000000000000000000000000000008F
:10020000000000000000000000000000000000007F
:10021000000000000000000000000000000000006F
:10022000000000000000000000000000000000005F
:10023000000000000000000000000000000000004F
:10024000000000000000000000000000000000003F
:10025000000000000000000000000000000000002F
:10026000000000000000000000000000000000001F
:10027000000000000000000000000000000000000F
:1002800000000000000000000000000000000000FF
:1002900000000000000000000000000000000000EF
:1002A00000000000000000000000000000000000DF
:1002B00000000000000000000000000000000000CF
:1002C00000000000000000000000000000000000BF
:1002D00000000000000000000000000000000000AF
:1002E000000000000000000000000000000000009F
:1002F000000000000000000000000000000000008F
:10030000000000000000000000000000000000007F
:10031000000000000000000000000000000000006F
:10032000000000000000000000000000000000005F
:10033000000000000000000000000000000000004F
:10034000000000000000000000000000000000003F
:10035000000000000000000000000000000000002F
:10036000000000000000000000000000000000001F
:10037000000000000000000000000000000000000F
:1003800000000000000000000000000000000000FF
:1003900000000000000000000000000000000000EF
:1003A00000000000000000000000000000000000DF
:1003B00000000000000000000000000000000000CF
:1003C00000000000000000000000000000000000BF
:1003D00000000000000000000000000000000000AF
:1003E000000000000000000000000000000000009F
:1003F000000000000000000000000000000000008F
:10040000000000000000000000000000000000007F
:10041000000000000000000000000000000000006F
:10042000000000000000000000000000000000005F
:10043000000000000000000000000000000000004F
:10044000000000000000000000000000000000003F
:10045000000000000000000000000000000000002F
:10046000000000000000000000000000000000001F
:10047000000000000000000000000000000000000F
:1004800000000000000000000000000000000000FF
:1004900000000000000000000000000000000000EF
:1004A00000000000000000000000000000000000DF
:1004B00000000000000000000000000000000000CF
:1004C00000000000000000000000000000000000BF
:1004D00000000000000000000000000000000000AF
:1004E000000000000000000000000000000000009F
:1004F000000000000000000000000000000000008F
:10050000000000000000000000000000000000007F
:10051000000000000000000000000000000000006F
:10052000000000000000000000000000000000005F
:10053000000000000000000000000000000000004F
:10054000000000000000000000000000000000003F
:10055000000000000000000000000000000000002F
:10056000000000000000000000000000000000001F
:10057000000000000000000000000000000000000F
:1005800000000000000000000000000000000000FF
:1005900000000000000000000000000000000000EF
:1005A00000000000000000000000000000000000DF
:1005B00000000000000000000000000000000000CF
:1005C00000000000000000000000000000000000BF
:1005D00000000000000000000000000000000000AF
:1005E000000000000000000000000000000000009F
:1005F000000000000000000000000000000000008F
:10060000000000000000000000000000000000007F
:10061000000000000000000000000000000000006F
:10062000000000000000000000000000000000005F
:10063000000000000000000000000000000000004F
:10064000000000000000000000000000000000003F
:10065000000000000000000000000000000000002F
:10066000000000000000000000000000000000001F
:10067000000000000000000000000000000000000F
:1006800011241FBECFEFD8E0DEBFCDBF21E0A0E0B1E001C01D92A930B207E1F70E9440000C9400
:10068000000000000000000000000000000000008F
:00000001FF"""
    
    demo_file = "demo_blink.hex"
    with open(demo_file, 'w') as f:
        f.write(hex_content)
    
    print(f"âœ“ åˆ›å»ºæ¼”ç¤ºhexæ–‡ä»¶: {demo_file}")
    return demo_file

def demo_direct_flash():
    """æ¼”ç¤ºç›´æ¥ä½¿ç”¨AVRFlasherè¿›è¡Œçƒ§å½•"""
    print("\n=== ç›´æ¥çƒ§å½•æ¼”ç¤º ===")
    
    try:
        # åˆ›å»ºæ¼”ç¤ºæ–‡ä»¶
        hex_file = create_demo_hex()
        
        # åˆå§‹åŒ–çƒ§å½•å™¨
        flasher = AVRFlasher()
        
        # æ£€æŸ¥GPIOçŠ¶æ€
        if flasher.reset_pin:
            print(f"âœ“ GPIO {flasher.config.RESET_PIN} å·²é…ç½®ç”¨äºå¤ä½æ§åˆ¶")
        else:
            print("âš ï¸  GPIOå¤ä½åŠŸèƒ½ä¸å¯ç”¨")
        
        # æ‰§è¡Œçƒ§å½•
        print("\nå¼€å§‹çƒ§å½•æµç¨‹...")
        print("1. çƒ§å½•å‰å¤ä½è®¾å¤‡")
        print("2. æ‰§è¡Œavrdudeçƒ§å½•")
        print("3. çƒ§å½•åé‡å¯è®¾å¤‡")
        
        result = flasher.flash_hex_file(
            hex_file,
            mcu="atmega328p",
            programmer="arduino",
            port="/dev/ttyS0",
            baudrate=115200
        )
        
        # æ˜¾ç¤ºç»“æœ
        if result['success']:
            print(f"\nğŸ‰ çƒ§å½•æˆåŠŸ!")
            print(f"   è€—æ—¶: {result['duration']:.2f}ç§’")
            print("   è®¾å¤‡å·²è‡ªåŠ¨é‡å¯")
        else:
            print(f"\nâŒ çƒ§å½•å¤±è´¥: {result['message']}")
            if result['error']:
                print(f"   é”™è¯¯è¯¦æƒ…: {result['error']}")
        
        # æ¸…ç†
        flasher.cleanup()
        os.unlink(hex_file)
        
        return result['success']
        
    except Exception as e:
        print(f"âŒ ç›´æ¥çƒ§å½•æ¼”ç¤ºå¤±è´¥: {e}")
        return False

def demo_api_flash():
    """æ¼”ç¤ºé€šè¿‡APIè¿›è¡Œçƒ§å½•"""
    print("\n=== APIçƒ§å½•æ¼”ç¤º ===")
    
    try:
        # åˆ›å»ºæ¼”ç¤ºæ–‡ä»¶
        hex_file = create_demo_hex()
        
        # åˆ›å»ºAPIå®¢æˆ·ç«¯
        client = RemoteFlasherClient("http://localhost:5000")
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        print("æ£€æŸ¥APIæœåŠ¡çŠ¶æ€...")
        status = client.get_status()
        
        if status.get('status') != 'running':
            print("âŒ APIæœåŠ¡ä¸å¯ç”¨ï¼Œè¯·å…ˆå¯åŠ¨æœåŠ¡å™¨:")
            print("   python api_server.py")
            return False
        
        print(f"âœ“ APIæœåŠ¡è¿è¡Œæ­£å¸¸")
        print(f"   GPIOå¯ç”¨: {status.get('gpio_available', False)}")
        
        # æ‰§è¡Œçƒ§å½•
        print("\né€šè¿‡APIæ‰§è¡Œçƒ§å½•...")
        result = client.flash_file(
            hex_file,
            mcu="atmega328p",
            programmer="arduino",
            port="/dev/ttyS0",
            baudrate=115200
        )
        
        # æ˜¾ç¤ºç»“æœ
        if result.get('success'):
            print(f"\nğŸ‰ APIçƒ§å½•æˆåŠŸ!")
            print(f"   è€—æ—¶: {result.get('duration', 0):.2f}ç§’")
            print("   è®¾å¤‡å·²è‡ªåŠ¨é‡å¯")
        else:
            print(f"\nâŒ APIçƒ§å½•å¤±è´¥: {result.get('message', 'æœªçŸ¥é”™è¯¯')}")
            if result.get('error'):
                print(f"   é”™è¯¯è¯¦æƒ…: {result['error']}")
        
        # æ¸…ç†
        os.unlink(hex_file)
        
        return result.get('success', False)
        
    except Exception as e:
        print(f"âŒ APIçƒ§å½•æ¼”ç¤ºå¤±è´¥: {e}")
        return False

def demo_gpio_control():
    """æ¼”ç¤ºGPIOæ§åˆ¶åŠŸèƒ½"""
    print("\n=== GPIOæ§åˆ¶æ¼”ç¤º ===")
    
    try:
        flasher = AVRFlasher()
        
        if not flasher.reset_pin:
            print("âš ï¸  GPIOå¤ä½åŠŸèƒ½ä¸å¯ç”¨ï¼Œè·³è¿‡æ¼”ç¤º")
            return True
        
        print(f"ä½¿ç”¨GPIO {flasher.config.RESET_PIN}è¿›è¡Œå¤ä½æ§åˆ¶æ¼”ç¤º...")
        
        # æ¼”ç¤ºå¤ä½æ“ä½œ
        print("\n1. æ‰§è¡Œå¤ä½æ“ä½œ...")
        result1 = flasher.reset_target(duration=0.2)
        if result1:
            print("   âœ“ å¤ä½æˆåŠŸ (GPIO 23: é«˜->ä½->é«˜)")
        else:
            print("   âŒ å¤ä½å¤±è´¥")
        
        time.sleep(1)
        
        # æ¼”ç¤ºç”µæºå¾ªç¯ (å¦‚æœé…ç½®äº†ç”µæºå¼•è„š)
        if flasher.power_pin:
            print("\n2. æ‰§è¡Œç”µæºå¾ªç¯...")
            result2 = flasher.power_cycle_target(off_duration=1.0)
            if result2:
                print("   âœ“ ç”µæºå¾ªç¯æˆåŠŸ")
            else:
                print("   âŒ ç”µæºå¾ªç¯å¤±è´¥")
        else:
            print("\n2. ç”µæºå¾ªç¯åŠŸèƒ½æœªé…ç½®ï¼Œè·³è¿‡")
            result2 = True
        
        # æ¸…ç†
        flasher.cleanup()
        
        return result1 and result2
        
    except Exception as e:
        print(f"âŒ GPIOæ§åˆ¶æ¼”ç¤ºå¤±è´¥: {e}")
        return False

def main():
    """ä¸»æ¼”ç¤ºå‡½æ•°"""
    print("RemoteFlasher å®Œæ•´åŠŸèƒ½æ¼”ç¤º")
    print("=" * 50)
    print("æ¼”ç¤ºå†…å®¹:")
    print("1. GPIOæ§åˆ¶åŠŸèƒ½")
    print("2. ç›´æ¥çƒ§å½• (åŒ…å«çƒ§å½•å‰å¤ä½å’Œçƒ§å½•åé‡å¯)")
    print("3. APIçƒ§å½•")
    print("")
    
    # æ£€æŸ¥ç¯å¢ƒ
    if not Path("venv").exists():
        print("âŒ è™šæ‹Ÿç¯å¢ƒä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œ:")
        print("   python3 -m venv venv")
        print("   source venv/bin/activate")
        print("   pip install -r requirements.txt")
        return 1
    
    success_count = 0
    total_demos = 3
    
    try:
        # æ¼”ç¤º1: GPIOæ§åˆ¶
        if demo_gpio_control():
            success_count += 1
        
        # æ¼”ç¤º2: ç›´æ¥çƒ§å½•
        if demo_direct_flash():
            success_count += 1
        
        # æ¼”ç¤º3: APIçƒ§å½•
        if demo_api_flash():
            success_count += 1
        
        # æ€»ç»“
        print("\n" + "=" * 50)
        print(f"æ¼”ç¤ºå®Œæˆ: {success_count}/{total_demos} æˆåŠŸ")
        
        if success_count == total_demos:
            print("ğŸ‰ æ‰€æœ‰åŠŸèƒ½æ¼”ç¤ºæˆåŠŸ!")
            print("\nRemoteFlasherå·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥é›†æˆåˆ°æ‚¨çš„åº”ç”¨ä¸­ã€‚")
        else:
            print("âš ï¸  éƒ¨åˆ†æ¼”ç¤ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥:")
            print("   1. ç¡¬ä»¶è¿æ¥æ˜¯å¦æ­£ç¡®")
            print("   2. avrdudeæ˜¯å¦å·²å®‰è£…")
            print("   3. ä¸²å£æƒé™æ˜¯å¦æ­£ç¡®")
            print("   4. APIæœåŠ¡å™¨æ˜¯å¦è¿è¡Œ")
        
        return 0 if success_count == total_demos else 1
        
    except KeyboardInterrupt:
        print("\n\nç”¨æˆ·ä¸­æ–­æ¼”ç¤º")
        return 1
    except Exception as e:
        print(f"\n\næ¼”ç¤ºè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {e}")
        return 1

if __name__ == '__main__':
    sys.exit(main())
